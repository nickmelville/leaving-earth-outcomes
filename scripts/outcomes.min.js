!function(){var e=document.querySelector("#addAdvancementButton"),t=document.querySelector("#changeMode"),n=document.querySelector("#mainContent"),o=document.querySelector("#resetButton"),i=document.querySelector("#resetGameModal"),a=i.querySelector("#resetModalYesButton"),c=i.querySelector("#resetModalCancelButton"),r=document.querySelector("#newAdvancementModal"),s=document.querySelector("#numberOfOutcomes"),m=document.querySelector("#outcomeResultModal"),d=m.querySelector("#outcomeContent"),u=m.querySelector("#shuffleOutcomesButton"),l=m.querySelector("#removeOutcomeButton"),g=document.querySelector("#blanket"),h=navigator.userAgent.indexOf("iPhone")>-1||navigator.userAgent.indexOf("iPad")>-1?"touchend":"click",f={},v=function(e){var t,n,o;for(t=e.length-1;t>0;t--)n=Math.floor(Math.random()*(t+1)),o=e[t],e[t]=e[n],e[n]=o;return e},y=function(){var e,t=[];for(e=1;90>=e;e++)t.push(e);return v(t)},p=function(){return{config:{mode:"normal"},currentPlayer:"p1",outcomesDeck:y(),discardDeck:[],players:{p1:{name:"Player 1",advancements:{}},p2:{name:"Player 2",advancements:{}},p3:{name:"Player 3",advancements:{}},p4:{name:"Player 4",advancements:{}},p5:{name:"Player 5",advancements:{}}}}},S=window.Storage&&window.localStorage.getItem("storedState")?JSON.parse(window.localStorage.getItem("storedState")):p(),w=function(){var e=document.documentElement.clientWidth,t=S.config;"normal"===t.mode&&(t.containerWidth=350>e?e-25:325,t.outcomeMargin=25,t.outcomeDimension=t.containerWidth/2-60,t.advancementMargin=t.outcomeDimension+40,t.advancementFontSize="20px"),"compact"===t.mode&&(t.containerWidth=185>e?e-25:160,t.outcomeMargin=20,t.outcomeDimension=t.containerWidth/2-50,t.advancementMargin=t.outcomeDimension+25,t.advancementFontSize="12px"),t.containerHeight=t.containerWidth/2,t.dialogWidth=350>e?e-25:325,t.advancementHeight=t.containerHeight-40,t.advancementWidth=t.containerWidth-25,t.maximumOutcomes={Surveying:1}},b=function(e){e.style.width=S.config.dialogWidth+"px",e.style.bottom="50%",e.style.left="50%",e.style.marginBottom="-"+e.offsetHeight/2+"px",e.style.marginLeft="-"+e.offsetWidth/2+"px",e.style.visibility="visible"},D=function(e){var t,n,o=r.querySelectorAll("span");for(t in e.advancements)if(e.advancements.hasOwnProperty(t))for(n=0;n<o.length;n++)e.advancements[t].name===o[n].getAttribute("data-name")&&(o[n].className="disabled")},k=function(){g.style.visibility="visible",E(),s.querySelector('[data-number="3"]').className+=" selected",D(S.players[S.currentPlayer]),b(r)},L=function(){g.style.visibility="visible",b(i)},x=function(){window.Storage&&window.localStorage.removeItem("storedState"),window.location.reload()},M=function(){var e;try{var t=document.querySelectorAll(".modal");for(e=0;e<t.length;e++)t[e].style.visibility="hidden";u.style.visibility="inherit",l.style.visibility="inherit",g.style.visibility="hidden"}catch(n){alert(n.message)}},q=function(){var e=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},E=function(){var e=s.querySelector("span.selected"),t=s.querySelector("span.warning");e&&(e.className=e.className.replace("selected","").replace(/\s$/,"")),t&&(t.className=t.className.replace("warning","").replace(/\s$/,""))},O=function(e){var t,n,o,i,a=e.target,c=q(),r=s.querySelector("span.selected");a.className.indexOf("advancement")>-1&&-1===a.className.indexOf("disabled")&&(o=S.config.maximumOutcomes[a.getAttribute("data-name")],n=r.getAttribute("data-number"),n>o?(t=s.querySelector('[data-number="'+o+'"]'),-1===t.className.indexOf("warning")&&(t.className+=" warning")):(i={player:S.currentPlayer,id:c,name:a.getAttribute("data-name"),outcomes:[],maxLength:n,finalRevealed:!1},S.players[S.currentPlayer].advancements[c]=i,f[c]=new R(i),M(),E(),I())),a.className.indexOf("number")>-1&&-1===a.className.indexOf("selected")&&(E(),a.className+=" selected")},C=function(){S.config.mode="normal"===S.config.mode?"compact":"normal",I(),window.location.reload()},P=function(){e.addEventListener(h,k),o.addEventListener(h,L),t.addEventListener(h,C),r.addEventListener(h,O),a.addEventListener(h,x),c.addEventListener(h,M),g.addEventListener(h,M)},N=function(){var e,t=S.players[S.currentPlayer].advancements;for(e in t)t.hasOwnProperty(e)&&(f[e]=new R(t[e]))},W=function(){S.outcomesDeck=v(S.discardDeck),S.discardDeck=[]},F=function(e){var t=SVG(n).size(S.config.containerWidth,S.config.containerHeight);return t.rect(S.config.advancementWidth,S.config.advancementHeight).attr({x:15,y:15,fill:"#fff",stroke:"#000"}),t.text(e).attr({x:S.config.advancementMargin,y:S.config.outcomeMargin}).font({family:"Courier",size:S.config.advancementFontSize}),t.image("img/0.png").attr({width:S.config.outcomeDimension,height:S.config.outcomeDimension,x:S.config.outcomeMargin,y:S.config.outcomeMargin}),t},H=function(e,t,n){var o;switch(e){case 2:o="img/3.png";break;case 1:o="img/2.png";break;case 0:o="img/1.png"}return{outcomeCard:t.rect(S.config.outcomeDimension,S.config.outcomeDimension).attr({x:S.config.outcomeMargin,y:S.config.outcomeMargin,fill:"#fff",stroke:"#000",id:n}),outcomeImage:t.image(o).attr({width:S.config.outcomeDimension,height:S.config.outcomeDimension,x:S.config.outcomeMargin,y:S.config.outcomeMargin,id:n})}},A=function(){u.style.marginTop=m.offsetHeight-200+"px",l.style.marginTop=m.offsetHeight-200+"px",u.style.visibility="visible",l.style.visibility="visible"},R=function(e){var t,n,o,i,a=this;for(this.player=e.player,this.outcomes=e.outcomes,this.maxLength=e.maxLength,this.name=e.name,this.finalRevealed=e.finalRevealed,this.id=e.id,this.showOutcomeResult=function(){var e=a.outcomesDeck.last().attr("outcome"),t=1===a.outcomesDeck.members.length,n=function(){t?(d.innerHTML="Final Success!<br/><br/>Click anywhere to remove.",u.style.visibility="hidden",l.style.visibility="hidden",g.addEventListener(h,c),m.addEventListener(h,c)):(d.innerHTML="Success!",g.addEventListener(h,i))},o=function(){g.addEventListener(h,i),76>e?d.innerHTML="Minor Failure!":91>e&&(d.innerHTML="Major Failure!")},i=function(){var e=a.id,n=[],o=0;t&&(a.showFinalCard(),S.players[S.currentPlayer].advancements[e].finalRevealed=!0),a.outcomesDeck.each(function(){n.push(this.attr("outcome"))}),n=v(n),a.outcomesDeck.each(function(){this.attr({outcome:n[o]}),o++}),I(),r()},c=function(){var t,n,o=a.id,i=[],c=0;for(a.outcomesDeck.last().remove(),a.outcomesDeck.members.pop(),t=a.outcomesDeck.members,n=0;n<t.length;n++)i.push(t[n].attr("outcome")),c+=1;S.players[S.currentPlayer].advancements[o].outcomes=i,S.players[S.currentPlayer].advancements[o].maxLength=c,S.discardDeck.push(e),I(),r()},r=function(){g.removeEventListener(h,i),g.removeEventListener(h,c),m.removeEventListener(h,c),u.removeEventListener(h,i),l.removeEventListener(h,c),g.addEventListener(h,M),M()};u.addEventListener(h,i),l.addEventListener(h,c),g.style.visibility="visible",A(),b(m),g.removeEventListener(h,M),61>e?n():o()},this.showFinalCard=function(){var e,t=1===this.outcomesDeck.members.length,n=this.outcomesDeck.last().attr("outcome");e="normal"===S.config.mode?76>n?"img/minor.png":"img/major.png":76>n?"img/minor-compact.png":"img/major-compact.png",t&&this.outcomesDeck.last().get(1).load(e)};this.outcomes.length<this.maxLength;)S.outcomesDeck.length||W(),this.outcomes.push(S.outcomesDeck.shift());for(this.outcomes=v(this.outcomes),this.advancementContainer=F(this.name),this.outcomesDeck=this.advancementContainer.set(),t=0,n=this.outcomes.length;n>t;t++)o=H(t,this.advancementContainer,this.id),i=this.advancementContainer.group(),i.add(o.outcomeCard),i.add(o.outcomeImage),i.attr({id:this.id,outcome:this.outcomes[t],x:o.outcomeCard.x(),y:o.outcomeImage.y()}),this.outcomesDeck.add(i);return this.finalRevealed===!0&&1===this.outcomesDeck.members.length&&this.showFinalCard(),this.outcomesDeck.on("click",this.showOutcomeResult),{outcomesDeck:this.outcomesDeck,showFinalCard:this.showFinalCard,showOutcomeResult:this.showOutcomeResult}},I=function(){window.Storage&&(window.localStorage.removeItem("storedState"),window.localStorage.setItem("storedState",JSON.stringify(S)))},B=function(){w(),P(),N(),I(),FastClick.attach(document.body)};B()}();